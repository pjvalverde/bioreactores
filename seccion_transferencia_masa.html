<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transferencia de Masa en Bioprocesos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            margin-top: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 0;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            font-size: 1.2em;
            font-weight: 300;
            opacity: 0.9;
        }

        .section {
            margin: 40px 0;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #e74c3c;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 2em;
            border-bottom: 3px solid #e74c3c;
            padding-bottom: 10px;
        }

        .highlight-box {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #e74c3c;
        }

        .simulation-container {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .simulation-title {
            color: #e74c3c;
            font-size: 1.4em;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
        }

        .canvas-container {
            position: relative;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }

        .diffusion-canvas {
            width: 100%;
            height: 300px;
            border-radius: 8px;
            background: linear-gradient(45deg, #e3f2fd 25%, transparent 25%, transparent 75%, #e3f2fd 75%), 
                        linear-gradient(45deg, #e3f2fd 25%, transparent 25%, transparent 75%, #e3f2fd 75%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            font-weight: 500;
            color: #495057;
            min-width: 80px;
        }

        .control-group input[type="range"] {
            width: 120px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .btn-primary {
            background: #e74c3c;
            color: white;
        }

        .btn-primary:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .equation-box {
            background: #f1f3f4;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-family: 'Courier New', monospace;
            border: 2px solid #e74c3c;
        }

        .equation {
            font-size: 1.2em;
            color: #2c3e50;
            margin: 10px 0;
        }

        .info-panel {
            background: #e8f4f8;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .stats-panel {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            text-align: center;
        }

        .stat-item {
            padding: 10px;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #e74c3c;
        }

        .stat-label {
            font-size: 0.8em;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .process-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            border-bottom: 2px solid #e9ecef;
        }

        .tab {
            padding: 12px 20px;
            background: #f8f9fa;
            border: none;
            border-radius: 10px 10px 0 0;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #6c757d;
        }

        .tab.active {
            background: #e74c3c;
            color: white;
            transform: translateY(-2px);
        }

        .tab-content {
            display: none;
            padding: 20px 0;
        }

        .tab-content.active {
            display: block;
        }

        .process-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .process-card:hover {
            border-color: #e74c3c;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.15);
        }

        .process-card.active {
            border-color: #e74c3c;
            background: #fff5f5;
        }

        .process-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .process-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 15px;
            }

            h1 {
                font-size: 2em;
            }

            .controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚öõÔ∏è Transferencia de Masa en Bioprocesos</h1>
            <p class="subtitle">Fundamentos de Difusion y Simulaciones Interactivas</p>
        </header>

        <section class="section">
            <h2>üåä Conceptos Fundamentales</h2>
            
            <div class="highlight-box">
                <h3>¬øQue es la Transferencia de Masa?</h3>
                <p>La transferencia de masa es el movimiento neto de materia de una region a otra como resultado de gradientes de concentracion. En bioprocesos, la difusion es el mecanismo fundamental que permite el intercambio de nutrientes, oxigeno, productos metabolicos y desechos entre diferentes fases.</p>
            </div>

            <div class="equation-box">
                <div class="equation">Ley de Fick (Primera Ley)</div>
                <div class="equation">J = -D √ó (dC/dx)</div>
                <p style="font-size: 0.9em; margin-top: 10px;">
                    <strong>J:</strong> Flujo difusivo (mol/m¬≤¬∑s) ‚Ä¢
                    <strong>D:</strong> Coeficiente de difusion (m¬≤/s) ‚Ä¢
                    <strong>dC/dx:</strong> Gradiente de concentracion
                </p>
            </div>

            <div class="info-panel">
                <strong>üí° Principio Clave:</strong> Las moleculas se mueven desde regiones de alta concentracion hacia regiones de baja concentracion hasta alcanzar el equilibrio.
            </div>
        </section>

        <section class="section">
            <h2>üß™ Simulacion Interactiva de Difusion</h2>
            
            <div class="simulation-container">
                <div class="simulation-title">Difusion Molecular Basica</div>
                
                <div class="canvas-container">
                    <canvas id="diffusionCanvas" class="diffusion-canvas" width="800" height="300"></canvas>
                </div>

                <div class="controls">
                    <div class="control-group">
                        <label>Velocidad:</label>
                        <input type="range" id="speedControl" min="1" max="10" value="3">
                        <span id="speedValue">3</span>
                    </div>
                    <div class="control-group">
                        <label>Temperatura:</label>
                        <input type="range" id="tempControl" min="1" max="10" value="5">
                        <span id="tempValue">25¬∞C</span>
                    </div>
                    <div class="control-group">
                        <label>Densidad:</label>
                        <input type="range" id="densityControl" min="1" max="10" value="5">
                        <span id="densityValue">Media</span>
                    </div>
                    <button class="btn btn-primary" id="startBtn">‚ñ∂Ô∏è Iniciar</button>
                    <button class="btn btn-secondary" id="resetBtn">üîÑ Reiniciar</button>
                </div>

                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #e74c3c;"></div>
                        <span>Moleculas Fase A (Alta concentracion)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #3498db;"></div>
                        <span>Moleculas Fase B (Baja concentracion)</span>
                    </div>
                </div>

                <div class="stats-panel">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="timeElapsed">0</div>
                            <div class="stat-label">Tiempo (s)</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="transferRate">0</div>
                            <div class="stat-label">Velocidad Transferencia</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="equilibrium">0%</div>
                            <div class="stat-label">Equilibrio</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="section">
            <h2>üè≠ Aplicaciones en Bioprocesos</h2>
            
            <div class="process-tabs">
                <button class="tab active" data-tab="distillation">üå°Ô∏è Destilacion</button>
                <button class="tab" data-tab="extraction">üß™ Extraccion</button>
                <button class="tab" data-tab="crystallization">üíé Cristalizacion</button>
                <button class="tab" data-tab="reverse-osmosis">üíß Osmosis Inversa</button>
            </div>

            <div class="tab-content active" id="distillation">
                <h3>Destilacion en Bioprocesos</h3>
                <div class="simulation-container">
                    <div class="simulation-title">Separacion Etanol-Agua</div>
                    <canvas id="distillationCanvas" class="diffusion-canvas" width="800" height="300"></canvas>
                    <div class="info-panel">
                        <strong>Proceso:</strong> El componente menos volatil (agua) se difunde hacia la interfase a traves de la fase liquida, mientras el componente mas volatil (etanol) se difunde hacia el vapor.
                    </div>
                </div>
            </div>

            <div class="tab-content" id="extraction">
                <h3>Extraccion Liquido-Liquido</h3>
                <div class="simulation-container">
                    <div class="simulation-title">Extraccion de Proteinas</div>
                    <canvas id="extractionCanvas" class="diffusion-canvas" width="800" height="300"></canvas>
                    <div class="info-panel">
                        <strong>Proceso:</strong> El soluto (proteina) se difunde a traves de la fase acuosa hacia la interfase y despues hacia la fase organica extractante.
                    </div>
                </div>
            </div>

            <div class="tab-content" id="crystallization">
                <h3>Cristalizacion</h3>
                <div class="simulation-container">
                    <div class="simulation-title">Formacion de Cristales de Sal</div>
                    <canvas id="crystallizationCanvas" class="diffusion-canvas" width="800" height="300"></canvas>
                    <div class="info-panel">
                        <strong>Proceso:</strong> El soluto se difunde a traves del licor madre hacia los nucleos de cristalizacion y se deposita sobre las superficies solidas.
                    </div>
                </div>
            </div>

            <div class="tab-content" id="reverse-osmosis">
                <h3>Osmosis Inversa</h3>
                <div class="simulation-container">
                    <div class="simulation-title">Purificacion de Agua por Osmosis Inversa</div>
                    
                    <div class="controls">
                        <div class="control-group">
                            <label>Presion:</label>
                            <input type="range" id="pressureControl" min="1" max="10" value="7">
                            <span id="pressureValue">70 bar</span>
                        </div>
                        <div class="control-group">
                            <label>Concentracion:</label>
                            <input type="range" id="concentrationControl" min="1" max="10" value="6">
                            <span id="concentrationValue">Media</span>
                        </div>
                        <button class="btn btn-primary" id="roStartBtn">‚ñ∂Ô∏è Iniciar RO</button>
                        <button class="btn btn-secondary" id="roResetBtn">üîÑ Reiniciar</button>
                    </div>
                    
                    <canvas id="reverseOsmosisCanvas" class="diffusion-canvas" width="800" height="300"></canvas>
                    
                    <div class="stats-panel">
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value" id="roFlowRate">0</div>
                                <div class="stat-label">Flujo Permeado (L/h)</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="roRejection">0%</div>
                                <div class="stat-label">Rechazo de Sales</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="roRecovery">0%</div>
                                <div class="stat-label">Recuperacion</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="roEfficiency">0%</div>
                                <div class="stat-label">Eficiencia Total</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #3498db;"></div>
                            <span>Moleculas de Agua (H2O)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #e74c3c;"></div>
                            <span>Iones de Sal (Na+, Cl-)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #f39c12;"></div>
                            <span>Contaminantes Organicos</span>
                        </div>
                    </div>
                    
                    <div class="info-panel">
                        <strong>Proceso:</strong> La osmosis inversa utiliza presion para forzar el paso del agua a traves de una membrana semipermeable, bloqueando sales, contaminantes y microorganismos.
                        
                        <div class="equation-box" style="margin-top: 15px;">
                            <div class="equation">Flujo de Agua: J = A √ó (ŒîP - ŒîœÄ)</div>
                            <p style="font-size: 0.8em; margin-top: 8px;">
                                <strong>J:</strong> Flujo de agua ‚Ä¢ <strong>A:</strong> Permeabilidad de la membrana<br>
                                <strong>ŒîP:</strong> Diferencia de presion ‚Ä¢ <strong>ŒîœÄ:</strong> Diferencia de presion osmotica
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="section">
            <h2>üéØ Casos Practicos Interactivos</h2>
            
            <div class="process-grid">
                <div class="process-card" onclick="selectProcess('fermentation')">
                    <div class="process-icon">üç∫</div>
                    <h4>Fermentacion</h4>
                    <p>Transferencia de O2 y CO2 en cultivos microbianos. Difusion de nutrientes hacia las celulas.</p>
                </div>
                
                <div class="process-card" onclick="selectProcess('bioreactor')">
                    <div class="process-icon">‚öóÔ∏è</div>
                    <h4>Biorreactor</h4>
                    <p>Difusion de sustratos desde el centro hacia la periferia. Gradientes de concentracion y mezclado.</p>
                </div>
            </div>

            <div class="simulation-container" id="practicalSimulation" style="display: none;">
                <div class="simulation-title" id="practicalTitle">Selecciona un proceso arriba</div>
                <canvas id="practicalCanvas" class="diffusion-canvas" width="800" height="300"></canvas>
                <div class="info-panel" id="practicalInfo">
                    Haz clic en una de las tarjetas de proceso para ver la simulacion correspondiente.
                </div>
            </div>
        </section>
    </div>

    <script>
        // Variables globales
        let canvas, ctx;
        let isRunning = false;
        let molecules = [];
        let time = 0;
        let animationId;

        // Variables RO
        let roIsRunning = false;
        let roParticles = [];
        let roTime = 0;
        let roAnimationId;

        // Variables para otras simulaciones
        let processAnimations = {};
        let processTime = 0;
        let processAnimationId;
        let practicalAnimations = {};
        let practicalTime = 0;
        let practicalAnimationId;

        const config = {
            speed: 3,
            temperature: 5,
            density: 5
        };

        const roConfig = {
            pressure: 7,
            concentration: 6
        };

        // Inicializacion
        document.addEventListener('DOMContentLoaded', function() {
            initializeSimulation();
            setupEventListeners();
            setupTabs();
            initializeMolecules();
        });

        function initializeSimulation() {
            canvas = document.getElementById('diffusionCanvas');
            if (!canvas) return;
            
            ctx = canvas.getContext('2d');
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
        }

        function resizeCanvas() {
            if (!canvas) return;
            const container = canvas.parentElement;
            const rect = container.getBoundingClientRect();
            canvas.width = rect.width - 4;
            canvas.height = 300;
        }

        function setupEventListeners() {
            // Controles principales
            const speedControl = document.getElementById('speedControl');
            const tempControl = document.getElementById('tempControl');
            const densityControl = document.getElementById('densityControl');
            const startBtn = document.getElementById('startBtn');
            const resetBtn = document.getElementById('resetBtn');

            if (speedControl) {
                speedControl.addEventListener('input', function(e) {
                    config.speed = parseInt(e.target.value);
                    document.getElementById('speedValue').textContent = config.speed;
                });
            }

            if (tempControl) {
                tempControl.addEventListener('input', function(e) {
                    config.temperature = parseInt(e.target.value);
                    const temp = 10 + (config.temperature - 1) * 5;
                    document.getElementById('tempValue').textContent = temp + '¬∞C';
                });
            }

            if (densityControl) {
                densityControl.addEventListener('input', function(e) {
                    config.density = parseInt(e.target.value);
                    const densities = ['Muy Baja', 'Baja', 'Baja-Media', 'Media', 'Media', 'Media-Alta', 'Alta', 'Muy Alta', 'Extrema', 'Maxima'];
                    document.getElementById('densityValue').textContent = densities[config.density - 1];
                    if (!isRunning) {
                        initializeMolecules();
                        drawFrame();
                    }
                });
            }

            if (startBtn) {
                startBtn.addEventListener('click', toggleSimulation);
            }
            if (resetBtn) {
                resetBtn.addEventListener('click', resetSimulation);
            }

            // Controles RO
            setupROControls();
        }

        function setupROControls() {
            const pressureControl = document.getElementById('pressureControl');
            const concentrationControl = document.getElementById('concentrationControl');
            const roStartBtn = document.getElementById('roStartBtn');
            const roResetBtn = document.getElementById('roResetBtn');

            if (pressureControl) {
                pressureControl.addEventListener('input', function(e) {
                    roConfig.pressure = parseInt(e.target.value);
                    document.getElementById('pressureValue').textContent = (roConfig.pressure * 10) + ' bar';
                });
            }

            if (concentrationControl) {
                concentrationControl.addEventListener('input', function(e) {
                    roConfig.concentration = parseInt(e.target.value);
                    const concentrations = ['Muy Baja', 'Baja', 'Baja-Media', 'Media-Baja', 'Media', 'Media-Alta', 'Alta', 'Muy Alta', 'Extrema', 'Salmuera'];
                    document.getElementById('concentrationValue').textContent = concentrations[roConfig.concentration - 1];
                });
            }

            if (roStartBtn) {
                roStartBtn.addEventListener('click', function() {
                    if (roIsRunning) {
                        stopReverseOsmosis();
                        this.innerHTML = '‚ñ∂Ô∏è Iniciar RO';
                    } else {
                        startReverseOsmosis();
                        this.innerHTML = '‚è∏Ô∏è Pausar RO';
                    }
                });
            }

            if (roResetBtn) {
                roResetBtn.addEventListener('click', resetReverseOsmosis);
            }
        }

        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    
                    this.classList.add('active');
                    const targetContent = document.getElementById(tabId);
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }

                    // Detener animaciones previas
                    stopProcessAnimations();

                    // Inicializar simulacion especifica
                    setTimeout(function() {
                        initializeProcessSimulation(tabId);
                        startProcessAnimation(tabId);
                    }, 100);
                });
            });

            // Inicializar la primera pesta√±a
            setTimeout(function() {
                initializeProcessSimulation('distillation');
                startProcessAnimation('distillation');
            }, 200);
        }

        function startProcessAnimation(processType) {
            processAnimations[processType] = true;
            animateProcess(processType);
        }

        function stopProcessAnimations() {
            for (let key in processAnimations) {
                processAnimations[key] = false;
            }
            if (processAnimationId) {
                cancelAnimationFrame(processAnimationId);
            }
        }

        function animateProcess(processType) {
            if (!processAnimations[processType]) return;

            processTime += 0.02; // Reducido de 0.05 a 0.02 (mas lento)
            drawProcessSimulations(processType);
            
            processAnimationId = requestAnimationFrame(function() {
                animateProcess(processType);
            });
        }

        function initializeProcessSimulation(processType) {
            if (processType === 'reverse-osmosis') {
                initializeROParticles();
                const roCanvas = document.getElementById('reverseOsmosisCanvas');
                if (roCanvas) {
                    roCanvas.width = roCanvas.parentElement.clientWidth - 4;
                    roCanvas.height = 300;
                    drawReverseOsmosisProcess(roCanvas.getContext('2d'), roCanvas);
                }
            }
            
            // Dibujar otras simulaciones
            drawProcessSimulations(processType);
        }

        function drawProcessSimulations(processType) {
            const canvasMap = {
                'distillation': 'distillationCanvas',
                'extraction': 'extractionCanvas',
                'crystallization': 'crystallizationCanvas'
            };
            
            const canvasId = canvasMap[processType];
            if (!canvasId) return;
            
            const processCanvas = document.getElementById(canvasId);
            if (!processCanvas) return;
            
            processCanvas.width = processCanvas.parentElement.clientWidth - 4;
            processCanvas.height = 300;
            
            const ctx = processCanvas.getContext('2d');
            
            switch(processType) {
                case 'distillation':
                    drawDistillationProcess(ctx, processCanvas);
                    break;
                case 'extraction':
                    drawExtractionProcess(ctx, processCanvas);
                    break;
                case 'crystallization':
                    drawCrystallizationProcess(ctx, processCanvas);
                    break;
            }
        }

        function initializeMolecules() {
            if (!canvas) return;
            
            molecules = [];
            const count = 20 + (config.density * 10);
            
            for (let i = 0; i < count; i++) {
                molecules.push({
                    x: Math.random() * (canvas.width * 0.4),
                    y: Math.random() * canvas.height,
                    vx: (Math.random() - 0.5) * config.speed * 0.5,
                    vy: (Math.random() - 0.5) * config.speed * 0.5,
                    type: 'high',
                    size: 3 + Math.random() * 2
                });
            }

            for (let i = 0; i < count * 0.3; i++) {
                molecules.push({
                    x: canvas.width * 0.6 + Math.random() * (canvas.width * 0.4),
                    y: Math.random() * canvas.height,
                    vx: (Math.random() - 0.5) * config.speed * 0.5,
                    vy: (Math.random() - 0.5) * config.speed * 0.5,
                    type: 'low',
                    size: 3 + Math.random() * 2
                });
            }
        }

        function initializeROParticles() {
            roParticles = [];
            const canvas = document.getElementById('reverseOsmosisCanvas');
            if (!canvas) return;

            const particleCount = 30 + (roConfig.concentration * 5);
            
            // Agua
            for (let i = 0; i < particleCount; i++) {
                roParticles.push({
                    x: Math.random() * (canvas.width * 0.35),
                    y: Math.random() * canvas.height,
                    vx: (Math.random() - 0.5) * 2,
                    vy: (Math.random() - 0.5) * 2,
                    type: 'water',
                    size: 3,
                    passed: false
                });
            }

            // Sales
            for (let i = 0; i < roConfig.concentration * 3; i++) {
                roParticles.push({
                    x: Math.random() * (canvas.width * 0.35),
                    y: Math.random() * canvas.height,
                    vx: (Math.random() - 0.5) * 1.5,
                    vy: (Math.random() - 0.5) * 1.5,
                    type: 'salt',
                    size: 4,
                    passed: false
                });
            }

            // Contaminantes
            for (let i = 0; i < roConfig.concentration * 2; i++) {
                roParticles.push({
                    x: Math.random() * (canvas.width * 0.35),
                    y: Math.random() * canvas.height,
                    vx: (Math.random() - 0.5) * 1,
                    vy: (Math.random() - 0.5) * 1,
                    type: 'organic',
                    size: 5,
                    passed: false
                });
            }
        }

        function toggleSimulation() {
            const btn = document.getElementById('startBtn');
            
            if (isRunning) {
                stopSimulation();
                if (btn) btn.innerHTML = '‚ñ∂Ô∏è Iniciar';
            } else {
                startSimulation();
                if (btn) btn.innerHTML = '‚è∏Ô∏è Pausar';
            }
        }

        function startSimulation() {
            isRunning = true;
            animate();
        }

        function stopSimulation() {
            isRunning = false;
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
        }

        function resetSimulation() {
            stopSimulation();
            time = 0;
            initializeMolecules();
            drawFrame();
            updateStats();
            const btn = document.getElementById('startBtn');
            if (btn) btn.innerHTML = '‚ñ∂Ô∏è Iniciar';
        }

        function animate() {
            if (!isRunning) return;
            
            updateMolecules();
            drawFrame();
            updateStats();
            
            time += 0.1;
            animationId = requestAnimationFrame(animate);
        }

        function updateMolecules() {
            if (!canvas) return;
            
            const boundaryX = canvas.width * 0.5;
            const diffusionRate = config.speed * 0.1;
            const temperatureEffect = config.temperature * 0.2;
            
            molecules.forEach(function(molecule) {
                molecule.vx += (Math.random() - 0.5) * temperatureEffect;
                molecule.vy += (Math.random() - 0.5) * temperatureEffect;
                
                molecule.vx *= 0.98;
                molecule.vy *= 0.98;
                
                if (molecule.type === 'high' && molecule.x < boundaryX) {
                    molecule.vx += diffusionRate;
                } else if (molecule.type === 'low' && molecule.x > boundaryX) {
                    molecule.vx -= diffusionRate;
                }
                
                molecule.x += molecule.vx;
                molecule.y += molecule.vy;
                
                if (molecule.x <= 0 || molecule.x >= canvas.width) {
                    molecule.vx *= -0.8;
                    molecule.x = Math.max(0, Math.min(canvas.width, molecule.x));
                }
                if (molecule.y <= 0 || molecule.y >= canvas.height) {
                    molecule.vy *= -0.8;
                    molecule.y = Math.max(0, Math.min(canvas.height, molecule.y));
                }
            });
        }

        function drawFrame() {
            if (!canvas || !ctx) return;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
            gradient.addColorStop(0, 'rgba(231, 76, 60, 0.1)');
            gradient.addColorStop(0.5, 'rgba(255, 255, 255, 0.1)');
            gradient.addColorStop(1, 'rgba(52, 152, 219, 0.1)');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const boundaryX = canvas.width * 0.5;
            ctx.strokeStyle = '#34495e';
            ctx.lineWidth = 3;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(boundaryX, 0);
            ctx.lineTo(boundaryX, canvas.height);
            ctx.stroke();
            ctx.setLineDash([]);
            
            molecules.forEach(function(molecule) {
                ctx.beginPath();
                ctx.arc(molecule.x, molecule.y, molecule.size, 0, Math.PI * 2);
                
                if (molecule.type === 'high') {
                    ctx.fillStyle = '#e74c3c';
                } else {
                    ctx.fillStyle = '#3498db';
                }
                
                ctx.fill();
            });
            
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 14px Arial';
            ctx.fillText('Fase A (Alta concentracion)', 10, 25);
            ctx.fillText('Fase B (Baja concentracion)', canvas.width - 200, 25);
        }

        function updateStats() {
            const timeElement = document.getElementById('timeElapsed');
            if (timeElement) timeElement.textContent = time.toFixed(1);
            
            if (!canvas) return;
            
            const boundaryX = canvas.width * 0.5;
            const crossings = molecules.filter(function(m) {
                return Math.abs(m.x - boundaryX) < 10;
            }).length;
            const transferElement = document.getElementById('transferRate');
            if (transferElement) transferElement.textContent = crossings;
            
            const leftSide = molecules.filter(function(m) { return m.x < boundaryX; }).length;
            const rightSide = molecules.filter(function(m) { return m.x > boundaryX; }).length;
            const total = molecules.length;
            const equilibrium = Math.min(leftSide, rightSide) / (total / 2) * 100;
            const equilibriumElement = document.getElementById('equilibrium');
            if (equilibriumElement) equilibriumElement.textContent = Math.round(equilibrium) + '%';
        }

        // Funciones de RO
        function startReverseOsmosis() {
            roIsRunning = true;
            animateReverseOsmosis();
        }

        function stopReverseOsmosis() {
            roIsRunning = false;
            if (roAnimationId) {
                cancelAnimationFrame(roAnimationId);
            }
        }

        function resetReverseOsmosis() {
            stopReverseOsmosis();
            roTime = 0;
            initializeROParticles();
            const canvas = document.getElementById('reverseOsmosisCanvas');
            if (canvas) {
                drawReverseOsmosisProcess(canvas.getContext('2d'), canvas);
            }
            updateROStats();
            const btn = document.getElementById('roStartBtn');
            if (btn) btn.innerHTML = '‚ñ∂Ô∏è Iniciar RO';
        }

        function animateReverseOsmosis() {
            if (!roIsRunning) return;
            
            updateROParticles();
            const canvas = document.getElementById('reverseOsmosisCanvas');
            if (canvas) {
                drawReverseOsmosisProcess(canvas.getContext('2d'), canvas);
            }
            updateROStats();
            
            roTime += 0.1;
            roAnimationId = requestAnimationFrame(animateReverseOsmosis);
        }

        function updateROParticles() {
            const canvas = document.getElementById('reverseOsmosisCanvas');
            if (!canvas) return;

            const membraneX = canvas.width * 0.4;
            const pressureEffect = roConfig.pressure * 0.3;
            
            roParticles.forEach(function(particle) {
                particle.vx += (Math.random() - 0.5) * 0.5;
                particle.vy += (Math.random() - 0.5) * 0.5;
                
                particle.vx *= 0.95;
                particle.vy *= 0.95;
                
                if (particle.x < membraneX && !particle.passed) {
                    particle.vx += pressureEffect * 0.5;
                }
                
                particle.x += particle.vx;
                particle.y += particle.vy;
                
                if (particle.y <= 0 || particle.y >= canvas.height) {
                    particle.vy *= -0.8;
                    particle.y = Math.max(0, Math.min(canvas.height, particle.y));
                }
                
                if (particle.x <= 0) {
                    particle.vx *= -0.5;
                    particle.x = 0;
                }
                
                if (particle.x >= membraneX - 5 && particle.x <= membraneX + 15 && !particle.passed) {
                    if (particle.type === 'water') {
                        const passChance = roConfig.pressure * 0.1;
                        if (Math.random() < passChance) {
                            particle.passed = true;
                            particle.vx = pressureEffect;
                        } else {
                            particle.vx *= -0.3;
                        }
                    } else {
                        const rejectChance = 0.85 + (roConfig.pressure * 0.01);
                        if (Math.random() < rejectChance) {
                            particle.vx *= -0.7;
                            particle.x = membraneX - 10;
                        } else {
                            particle.passed = true;
                            particle.vx = pressureEffect * 0.2;
                        }
                    }
                }
                
                if (particle.passed && particle.x >= canvas.width - 5) {
                    particle.vx *= -0.3;
                    particle.x = canvas.width - 5;
                }
            });
        }

        function drawReverseOsmosisProcess(ctx, canvas) {
            if (!ctx || !canvas) return;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = 'rgba(52, 152, 219, 0.2)';
            ctx.fillRect(0, 0, canvas.width * 0.4, canvas.height);
            
            const membraneX = canvas.width * 0.4;
            ctx.fillStyle = 'rgba(149, 165, 166, 0.9)';
            ctx.fillRect(membraneX, 0, 20, canvas.height);
            
            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
            for (let i = 0; i < 25; i++) {
                const x = membraneX + 2 + Math.random() * 16;
                const y = Math.random() * canvas.height;
                ctx.beginPath();
                ctx.arc(x, y, 1, 0, Math.PI * 2);
                ctx.fill();
            }
            
            ctx.fillStyle = 'rgba(46, 204, 113, 0.15)';
            ctx.fillRect(canvas.width * 0.4 + 20, 0, canvas.width * 0.6 - 20, canvas.height);
            
            ctx.strokeStyle = '#e74c3c';
            ctx.lineWidth = 3;
            ctx.setLineDash([10, 5]);
            for (let i = 0; i < 5; i++) {
                const y = (i + 1) * (canvas.height / 6);
                ctx.beginPath();
                ctx.moveTo(10, y);
                ctx.lineTo(membraneX - 10, y);
                ctx.stroke();
            }
            ctx.setLineDash([]);
            
            roParticles.forEach(function(particle) {
                ctx.beginPath();
                ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                
                switch(particle.type) {
                    case 'water':
                        ctx.fillStyle = '#3498db';
                        break;
                    case 'salt':
                        ctx.fillStyle = '#e74c3c';
                        break;
                    case 'organic':
                        ctx.fillStyle = '#f39c12';
                        break;
                }
                
                ctx.fill();
            });
            
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 16px Arial';
            ctx.fillText('Presion: ' + (roConfig.pressure * 10) + ' bar', 10, 30);
            
            ctx.font = 'bold 14px Arial';
            ctx.fillText('Agua de Alimentacion', 10, canvas.height - 60);
            ctx.fillText('Membrana RO', membraneX - 10, canvas.height - 10);
            ctx.fillText('Agua Purificada', canvas.width * 0.6, canvas.height - 60);
        }

        function updateROStats() {
            const waterPassed = roParticles.filter(function(p) { return p.type === 'water' && p.passed; }).length;
            const saltPassed = roParticles.filter(function(p) { return p.type === 'salt' && p.passed; }).length;
            const organicPassed = roParticles.filter(function(p) { return p.type === 'organic' && p.passed; }).length;
            const totalContaminants = roParticles.filter(function(p) { return p.type !== 'water'; }).length;
            const contaminantsPassed = saltPassed + organicPassed;
            
            const flowRate = Math.round(waterPassed * roConfig.pressure * 0.8);
            const roFlowRateElement = document.getElementById('roFlowRate');
            if (roFlowRateElement) {
                roFlowRateElement.textContent = flowRate;
            }
            
            const rejection = totalContaminants > 0 ? 
                Math.round(((totalContaminants - contaminantsPassed) / totalContaminants) * 100) : 0;
            const roRejectionElement = document.getElementById('roRejection');
            if (roRejectionElement) {
                roRejectionElement.textContent = rejection + '%';
            }
            
            const totalWater = roParticles.filter(function(p) { return p.type === 'water'; }).length;
            const recovery = totalWater > 0 ? Math.round((waterPassed / totalWater) * 100) : 0;
            const roRecoveryElement = document.getElementById('roRecovery');
            if (roRecoveryElement) {
                roRecoveryElement.textContent = recovery + '%';
            }
            
            const efficiency = Math.round((rejection * 0.6 + recovery * 0.4));
            const roEfficiencyElement = document.getElementById('roEfficiency');
            if (roEfficiencyElement) {
                roEfficiencyElement.textContent = efficiency + '%';
            }
        }

        // Funciones de dibujo para otros procesos
        function drawDistillationProcess(ctx, canvas) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Fase liquida (inferior)
            ctx.fillStyle = 'rgba(52, 152, 219, 0.3)';
            ctx.fillRect(0, canvas.height * 0.6, canvas.width, canvas.height * 0.4);
            
            // Fase vapor (superior)
            ctx.fillStyle = 'rgba(231, 76, 60, 0.2)';
            ctx.fillRect(0, 0, canvas.width, canvas.height * 0.6);
            
            // Interfase ondulada (mas lenta)
            ctx.strokeStyle = '#34495e';
            ctx.lineWidth = 2;
            ctx.setLineDash([10, 5]);
            ctx.beginPath();
            for (let x = 0; x <= canvas.width; x += 10) {
                const y = canvas.height * 0.6 + Math.sin(x * 0.02 + processTime * 1.5) * 3; // Reducido de 3 a 1.5
                if (x === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Moleculas de etanol (rojas, hacia arriba) - MAS LENTA
            for (let i = 0; i < 15; i++) {
                const baseX = (i * canvas.width) / 15;
                const x = baseX + Math.sin(processTime * 0.8 + i) * 15; // Reducido multiplicador y amplitud
                const y = canvas.height * 0.7 + Math.random() * canvas.height * 0.2 - Math.sin(processTime * 1.2 + i) * 20; // Mas lento
                
                if (y > canvas.height * 0.6) {
                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, Math.PI * 2);
                    ctx.fillStyle = '#e74c3c';
                    ctx.shadowColor = 'rgba(231, 76, 60, 0.5)';
                    ctx.shadowBlur = 8;
                    ctx.fill();
                    ctx.shadowBlur = 0;
                    
                    // Flecha hacia arriba (animada mas lenta)
                    drawAnimatedArrow(ctx, x, y - 10, x, y - 30, '#e74c3c', processTime * 0.5 + i);
                }
            }
            
            // Moleculas de agua (azules, hacia abajo) - MAS LENTA
            for (let i = 0; i < 10; i++) {
                const baseX = (i * canvas.width) / 10;
                const x = baseX + Math.cos(processTime * 0.6 + i) * 12; // Mas lento y menor amplitud
                const y = canvas.height * 0.2 + Math.random() * canvas.height * 0.3 + Math.cos(processTime * 0.8 + i) * 15; // Mas lento
                
                if (y < canvas.height * 0.6) {
                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, Math.PI * 2);
                    ctx.fillStyle = '#3498db';
                    ctx.shadowColor = 'rgba(52, 152, 219, 0.5)';
                    ctx.shadowBlur = 8;
                    ctx.fill();
                    ctx.shadowBlur = 0;
                    
                    // Flecha hacia abajo (animada mas lenta)
                    drawAnimatedArrow(ctx, x, y + 10, x, y + 30, '#3498db', processTime * 0.5 + i);
                }
            }
            
            // Burbujas de vapor subiendo (mas lentas)
            for (let i = 0; i < 8; i++) {
                const x = (i * canvas.width) / 8 + Math.sin(processTime * 0.4 + i * 0.5) * 8; // Mas lento
                const y = canvas.height * 0.8 - (processTime * 30 + i * 30) % (canvas.height * 0.6); // Mas lento
                
                ctx.beginPath();
                ctx.arc(x, y, 3 + Math.sin(processTime * 0.6 + i) * 2, 0, Math.PI * 2); // Mas lento
                ctx.fillStyle = 'rgba(231, 76, 60, 0.6)';
                ctx.fill();
            }
            
            // Etiquetas
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 14px Arial';
            ctx.fillText('Fase Vapor (Etanol enriquecido)', 10, 25);
            ctx.fillText('Fase Liquida (Agua enriquecida)', 10, canvas.height - 10);
            
            // Temperatura
            ctx.fillStyle = '#e74c3c';
            ctx.font = '12px Arial';
            ctx.fillText('T = 78¬∞C (Punto ebullicion etanol)', 10, 45);
        }

        function drawExtractionProcess(ctx, canvas) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Fase acuosa (izquierda)
            ctx.fillStyle = 'rgba(52, 152, 219, 0.3)';
            ctx.fillRect(0, 0, canvas.width * 0.5, canvas.height);
            
            // Fase organica (derecha)
            ctx.fillStyle = 'rgba(46, 204, 113, 0.3)';
            ctx.fillRect(canvas.width * 0.5, 0, canvas.width * 0.5, canvas.height);
            
            // Interfase vertical ondulada (mas lenta)
            ctx.strokeStyle = '#34495e';
            ctx.lineWidth = 3;
            ctx.beginPath();
            for (let y = 0; y <= canvas.height; y += 10) {
                const x = canvas.width * 0.5 + Math.sin(y * 0.02 + processTime * 0.5) * 3; // Mucho mas lento
                if (y === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();
            
            // Proteinas moviendose hacia la derecha - MUCHO MAS LENTA
            for (let i = 0; i < 12; i++) {
                const progress = (processTime * 0.08 + i * 0.1) % 1; // Mucho mas lento (era 0.2)
                const x = progress * canvas.width * 0.8;
                const y = (i * canvas.height) / 12 + Math.sin(processTime * 0.2 + i) * 6; // Mas lento
                
                ctx.beginPath();
                ctx.arc(x, y, 5, 0, Math.PI * 2);
                
                // Cambiar color segun la fase
                if (x < canvas.width * 0.5) {
                    ctx.fillStyle = '#9b59b6'; // En fase acuosa
                } else {
                    ctx.fillStyle = '#8e44ad'; // En fase organica
                }
                
                ctx.shadowColor = 'rgba(155, 89, 182, 0.5)';
                ctx.shadowBlur = 6;
                ctx.fill();
                ctx.shadowBlur = 0;
                
                // Flecha de movimiento (mucho mas lenta)
                if (x < canvas.width * 0.9 && x > 20) {
                    drawAnimatedArrow(ctx, x + 12, y, x + 25, y, '#9b59b6', processTime * 0.15 + i);
                }
            }
            
            // Gotas de extraccion en la interfase (mas lentas)
            for (let i = 0; i < 6; i++) {
                const y = (i * canvas.height) / 6;
                const x = canvas.width * 0.5 + Math.sin(processTime * 0.8 + i) * 4; // Mas lento y menor amplitud
                
                ctx.beginPath();
                ctx.arc(x, y, 2 + Math.sin(processTime * 0.5 + i), 0, Math.PI * 2); // Mas lento
                ctx.fillStyle = '#f39c12';
                ctx.fill();
            }
            
            // Etiquetas
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 14px Arial';
            ctx.fillText('Fase Acuosa', 10, 25);
            ctx.fillText('Fase Organica', canvas.width * 0.5 + 10, 25);
            ctx.fillText('(Proteinas)', 10, 45);
            ctx.fillText('(Extracto)', canvas.width * 0.5 + 10, 45);
            
            // Eficiencia
            ctx.fillStyle = '#27ae60';
            ctx.font = '12px Arial';
            ctx.fillText('Eficiencia: 85%', 10, canvas.height - 10);
        }

        function drawCrystallizationProcess(ctx, canvas) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Solucion sobresaturada con gradiente
            const gradient = ctx.createRadialGradient(canvas.width/2, canvas.height/2, 0, canvas.width/2, canvas.height/2, canvas.width/2);
            gradient.addColorStop(0, 'rgba(155, 89, 182, 0.4)');
            gradient.addColorStop(1, 'rgba(155, 89, 182, 0.1)');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Cristales creciendo (mas lento)
            const crystals = [
                {x: canvas.width * 0.2, y: canvas.height * 0.3, size: 15 + Math.sin(processTime * 0.5) * 3}, // Mas lento
                {x: canvas.width * 0.6, y: canvas.height * 0.7, size: 20 + Math.cos(processTime * 0.6) * 4}, // Mas lento
                {x: canvas.width * 0.8, y: canvas.height * 0.4, size: 12 + Math.sin(processTime * 0.4) * 2} // Mas lento
            ];
            
            crystals.forEach(function(crystal, crystalIndex) {
                // Dibujar cristal hexagonal con crecimiento (mas lento)
                ctx.beginPath();
                for (let i = 0; i < 6; i++) {
                    const angle = (i * Math.PI) / 3 + processTime * 0.05; // Mucho mas lento
                    const pointX = crystal.x + crystal.size * Math.cos(angle);
                    const pointY = crystal.y + crystal.size * Math.sin(angle);
                    
                    if (i === 0) ctx.moveTo(pointX, pointY);
                    else ctx.lineTo(pointX, pointY);
                }
                ctx.closePath();
                ctx.fillStyle = '#2c3e50';
                ctx.fill();
                ctx.strokeStyle = '#34495e';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Particulas depositandose - MAS LENTA
                for (let i = 0; i < 8; i++) {
                    const angle = (i / 8) * Math.PI * 2 + processTime * 0.5; // Mas lento
                    const distance = crystal.size + 30 + Math.sin(processTime * 0.4 + i) * 15; // Mas lento
                    const x = crystal.x + Math.cos(angle) * distance;
                    const y = crystal.y + Math.sin(angle) * distance;
                    
                    if (x > 0 && x < canvas.width && y > 0 && y < canvas.height) {
                        ctx.beginPath();
                        ctx.arc(x, y, 3, 0, Math.PI * 2);
                        ctx.fillStyle = '#e67e22';
                        ctx.shadowColor = 'rgba(230, 126, 34, 0.5)';
                        ctx.shadowBlur = 6;
                        ctx.fill();
                        ctx.shadowBlur = 0;
                        
                        // Flecha hacia el cristal (mas lenta)
                        const endX = crystal.x + Math.cos(angle) * (crystal.size + 10);
                        const endY = crystal.y + Math.sin(angle) * (crystal.size + 10);
                        drawAnimatedArrow(ctx, x, y, endX, endY, '#e67e22', processTime * 0.3 + i);
                    }
                }
            });
            
            // Nucleos de cristalizacion apareciendo (mas lento)
            for (let i = 0; i < 5; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const size = Math.sin(processTime * 1 + i * Math.PI) * 2 + 2; // Mas lento
                
                if (size > 0) {
                    ctx.beginPath();
                    ctx.arc(x, y, size, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(44, 62, 80, 0.7)';
                    ctx.fill();
                }
            }
            
            // Etiquetas
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 14px Arial';
            ctx.fillText('Licor Madre (Solucion sobresaturada)', 10, 25);
            ctx.fillText('Cristales en crecimiento', 10, 45);
            
            // Concentracion
            ctx.fillStyle = '#9b59b6';
            ctx.font = '12px Arial';
            ctx.fillText('Concentracion: 150% saturacion', 10, canvas.height - 10);
        }

        function drawAnimatedArrow(ctx, fromX, fromY, toX, toY, color, timeOffset) {
            const opacity = 0.5 + 0.5 * Math.sin(timeOffset * 2); // Mas lento (era 4)
            const headLen = 8;
            const angle = Math.atan2(toY - fromY, toX - fromX);
            
            ctx.globalAlpha = opacity;
            ctx.strokeStyle = color;
            ctx.fillStyle = color;
            ctx.lineWidth = 2;
            
            // Linea principal
            ctx.beginPath();
            ctx.moveTo(fromX, fromY);
            ctx.lineTo(toX, toY);
            ctx.stroke();
            
            // Cabeza de la flecha
            ctx.beginPath();
            ctx.moveTo(toX, toY);
            ctx.lineTo(toX - headLen * Math.cos(angle - Math.PI / 6), toY - headLen * Math.sin(angle - Math.PI / 6));
            ctx.lineTo(toX - headLen * Math.cos(angle + Math.PI / 6), toY - headLen * Math.sin(angle + Math.PI / 6));
            ctx.closePath();
            ctx.fill();
            
            ctx.globalAlpha = 1;
        }

        // Funcion para casos practicos
        function selectProcess(processType) {
            document.querySelectorAll('.process-card').forEach(function(card) {
                card.classList.remove('active');
            });
            
            event.target.closest('.process-card').classList.add('active');
            
            const practicalSim = document.getElementById('practicalSimulation');
            const practicalCanvas = document.getElementById('practicalCanvas');
            const practicalTitle = document.getElementById('practicalTitle');
            const practicalInfo = document.getElementById('practicalInfo');
            
            if (practicalSim) practicalSim.style.display = 'block';
            
            const processInfo = {
                'fermentation': {
                    title: 'Fermentacion - Transferencia O2/CO2',
                    info: 'En la fermentacion, el oxigeno se transfiere desde las burbujas de aire hacia las celulas microbianas, mientras que el CO2 producido se transfiere en direccion opuesta. Los nutrientes se difunden hacia las celulas a traves del medio de cultivo.'
                },
                'bioreactor': {
                    title: 'Biorreactor - Difusion de Sustratos',
                    info: 'En un biorreactor, los sustratos se difunden desde las zonas de alta concentracion (cerca del punto de adicion) hacia las zonas de menor concentracion. El gradiente impulsa la transferencia de masa hacia las celulas.'
                }
            };
            
            const info = processInfo[processType];
            if (info && practicalTitle && practicalInfo) {
                practicalTitle.textContent = info.title;
                practicalInfo.textContent = info.info;
            }
            
            // Detener animaciones anteriores
            stopPracticalAnimations();
            
            if (practicalCanvas) {
                const ctx = practicalCanvas.getContext('2d');
                practicalCanvas.width = practicalCanvas.parentElement.clientWidth - 4;
                practicalCanvas.height = 300;
                
                // Iniciar animacion especifica
                startPracticalAnimation(processType, ctx, practicalCanvas);
            }
        }

        function startPracticalAnimation(processType, ctx, canvas) {
            practicalAnimations[processType] = true;
            practicalTime = 0;
            animatePracticalProcess(processType, ctx, canvas);
        }

        function stopPracticalAnimations() {
            for (let key in practicalAnimations) {
                practicalAnimations[key] = false;
            }
            if (practicalAnimationId) {
                cancelAnimationFrame(practicalAnimationId);
            }
        }

        function animatePracticalProcess(processType, ctx, canvas) {
            if (!practicalAnimations[processType]) return;

            practicalTime += 0.015; // Mas lento para mejor observacion
            drawPracticalSimulation(ctx, processType, canvas);
            
            practicalAnimationId = requestAnimationFrame(function() {
                animatePracticalProcess(processType, ctx, canvas);
            });
        }

        function drawPracticalSimulation(ctx, processType, canvas) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            switch(processType) {
                case 'fermentation':
                    drawFermentationDemo(ctx, canvas);
                    break;
                case 'bioreactor':
                    drawBioreactorDemo(ctx, canvas);
                    break;
            }
        }

        function drawFermentationDemo(ctx, canvas) {
            // Medio de cultivo con gradiente
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, 'rgba(241, 196, 15, 0.2)');
            gradient.addColorStop(1, 'rgba(241, 196, 15, 0.4)');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Burbujas de aire subiendo - MAS LENTAS
            for (let i = 0; i < 8; i++) {
                const x = 80 + i * (canvas.width - 160) / 7;
                const y = canvas.height - 20 - (practicalTime * 25 + i * 30) % (canvas.height - 50); // Mas lento
                const size = 8 + Math.sin(practicalTime * 0.8 + i) * 2; // Mas lento
                
                // Burbuja de O2
                ctx.beginPath();
                ctx.arc(x, y, size, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(174, 214, 241, 0.8)';
                ctx.fill();
                ctx.strokeStyle = '#3498db';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Etiqueta O2
                ctx.fillStyle = '#2980b9';
                ctx.font = '10px Arial';
                ctx.fillText('O‚ÇÇ', x - 8, y + 3);
                
                // Estela de la burbuja (mas sutil)
                for (let j = 1; j <= 2; j++) {
                    const trailY = y + j * 20;
                    if (trailY < canvas.height) {
                        ctx.beginPath();
                        ctx.arc(x, trailY, size * (1 - j * 0.3), 0, Math.PI * 2);
                        ctx.fillStyle = `rgba(174, 214, 241, ${0.2 - j * 0.1})`;
                        ctx.fill();
                    }
                }
            }
            
            // Celulas microbianas - MAS LENTAS
            for (let i = 0; i < 6; i++) {
                const baseX = 120 + i * (canvas.width - 240) / 5;
                const x = baseX + Math.sin(practicalTime * 0.3 + i) * 10; // Mas lento
                const y = 100 + i * (canvas.height - 200) / 5 + Math.cos(practicalTime * 0.4 + i) * 8; // Mas lento
                
                // Celula con membrana
                ctx.beginPath();
                ctx.arc(x, y, 12, 0, Math.PI * 2);
                ctx.fillStyle = '#27ae60';
                ctx.fill();
                ctx.strokeStyle = '#229954';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Nucleo
                ctx.beginPath();
                ctx.arc(x - 2, y - 2, 4, 0, Math.PI * 2);
                ctx.fillStyle = '#1e8449';
                ctx.fill();
                
                // CO2 saliendo de las celulas (mas lento)
                const co2Angle = practicalTime * 0.5 + i; // Mas lento
                const co2X = x + Math.cos(co2Angle) * 20;
                const co2Y = y + Math.sin(co2Angle) * 20;
                
                ctx.beginPath();
                ctx.arc(co2X, co2Y, 3, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(192, 57, 43, 0.7)';
                ctx.fill();
                
                // Etiqueta CO2
                ctx.fillStyle = '#c0392b';
                ctx.font = '8px Arial';
                ctx.fillText('CO‚ÇÇ', co2X - 6, co2Y + 2);
                
                // Flecha de CO2 saliendo (mas lenta)
                if (practicalTime % 4 < 2) { // Aparece intermitentemente
                    drawAnimatedArrow(ctx, x + 12, y, co2X - 3, co2Y, '#c0392b', practicalTime * 0.5 + i);
                }
            }
            
            // Nutrientes difundiendose (mas lentos)
            for (let i = 0; i < 12; i++) {
                const x = 50 + (i * canvas.width) / 12 + Math.sin(practicalTime * 0.4 + i) * 20;
                const y = 50 + Math.random() * (canvas.height - 100) + Math.cos(practicalTime * 0.3 + i) * 15;
                const size = 2 + Math.sin(practicalTime * 1.2 + i) * 0.5; // Mas lento
                
                ctx.beginPath();
                ctx.arc(x, y, size, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(230, 126, 34, 0.6)';
                ctx.fill();
            }
            
            // Etiquetas y datos
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 16px Arial';
            ctx.fillText('Fermentacion Aerobica', 10, 25);
            
            ctx.font = '12px Arial';
            ctx.fillStyle = '#2980b9';
            ctx.fillText('O‚ÇÇ difunde hacia celulas', 10, 45);
            ctx.fillStyle = '#c0392b';
            ctx.fillText('CO‚ÇÇ difunde desde celulas', 10, 65);
            ctx.fillStyle = '#f39c12';
            ctx.fillText('Nutrientes en difusion', 10, canvas.height - 30);
            
            // Indicadores de transferencia
            ctx.fillStyle = '#27ae60';
            ctx.font = 'bold 11px Arial';
            ctx.fillText('kLa = 50 h‚Åª¬π', canvas.width - 100, 25);
            ctx.fillText('DO = 60%', canvas.width - 100, 45);
        }

        function drawBioreactorDemo(ctx, canvas) {
            // Fondo del biorreactor
            ctx.fillStyle = 'rgba(240, 248, 255, 0.8)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Tanque del biorreactor
            ctx.strokeStyle = '#34495e';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.arc(canvas.width / 2, canvas.height / 2, canvas.height * 0.35, 0, Math.PI * 2);
            ctx.stroke();
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const maxRadius = canvas.height * 0.35;
            
            // Punto de alimentacion de sustrato (arriba a la izquierda)
            const feedX = centerX - maxRadius * 0.6;
            const feedY = centerY - maxRadius * 0.6;
            
            // Gradiente de concentracion desde el punto de alimentacion
            const gradient = ctx.createRadialGradient(feedX, feedY, 0, feedX, feedY, maxRadius * 1.2);
            gradient.addColorStop(0, 'rgba(231, 76, 60, 0.9)');   // Alta concentracion en punto de alimentacion
            gradient.addColorStop(0.3, 'rgba(231, 76, 60, 0.6)');
            gradient.addColorStop(0.6, 'rgba(231, 76, 60, 0.3)');
            gradient.addColorStop(1, 'rgba(231, 76, 60, 0.1)');   // Baja concentracion lejos
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(centerX, centerY, maxRadius, 0, Math.PI * 2);
            ctx.fill();
            
            // Punto de alimentacion visible
            ctx.beginPath();
            ctx.arc(feedX, feedY, 8, 0, Math.PI * 2);
            ctx.fillStyle = '#e74c3c';
            ctx.fill();
            ctx.strokeStyle = '#c0392b';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // Etiqueta del punto de alimentacion
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 10px Arial';
            ctx.fillText('Alimentacion', feedX - 25, feedY - 15);
            ctx.fillText('Sustrato', feedX - 20, feedY - 5);
            
            // Moleculas de sustrato difundiendose desde el punto de alimentacion
            for (let i = 0; i < 25; i++) {
                const angle = (i / 25) * Math.PI * 2 + practicalTime * 0.2;
                const distance = (practicalTime * 15 + i * 8) % (maxRadius * 0.9);
                const x = feedX + Math.cos(angle) * distance;
                const y = feedY + Math.sin(angle) * distance;
                
                // Solo dibujar si esta dentro del tanque
                const distFromCenter = Math.sqrt((x - centerX)**2 + (y - centerY)**2);
                if (distFromCenter < maxRadius - 5) {
                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, Math.PI * 2);
                    
                    // Color segun distancia del punto de alimentacion (concentracion)
                    const distFromFeed = Math.sqrt((x - feedX)**2 + (y - feedY)**2);
                    const concentration = Math.max(0, 1 - (distFromFeed / (maxRadius * 0.8)));
                    const red = Math.round(231 * concentration + 52 * (1 - concentration));
                    const green = Math.round(76 * concentration + 152 * (1 - concentration));
                    const blue = Math.round(60 * concentration + 219 * (1 - concentration));
                    
                    ctx.fillStyle = `rgba(${red}, ${green}, ${blue}, 0.8)`;
                    ctx.fill();
                    
                    // Flecha de difusion desde alta a baja concentracion
                    if (i % 8 === 0 && distance > 20) {
                        const arrowEndX = x + Math.cos(angle) * 15;
                        const arrowEndY = y + Math.sin(angle) * 15;
                        drawAnimatedArrow(ctx, x - 5, y - 5, arrowEndX, arrowEndY, '#3498db', practicalTime + i);
                    }
                }
            }
            
            // Celulas distribuidas que consumen el sustrato
            for (let i = 0; i < 8; i++) {
                const cellAngle = (i / 8) * Math.PI * 2;
                const cellRadius = maxRadius * 0.7;
                const cellX = centerX + Math.cos(cellAngle) * cellRadius + Math.sin(practicalTime * 0.3 + i) * 5;
                const cellY = centerY + Math.sin(cellAngle) * cellRadius + Math.cos(practicalTime * 0.3 + i) * 5;
                
                // Celula
                ctx.beginPath();
                ctx.arc(cellX, cellY, 8, 0, Math.PI * 2);
                ctx.fillStyle = '#27ae60';
                ctx.fill();
                ctx.strokeStyle = '#229954';
                ctx.lineWidth = 1;
                ctx.stroke();
                
                // Zona de consumo alrededor de la celula
                ctx.beginPath();
                ctx.arc(cellX, cellY, 15, 0, Math.PI * 2);
                ctx.strokeStyle = 'rgba(39, 174, 96, 0.3)';
                ctx.lineWidth = 2;
                ctx.setLineDash([3, 3]);
                ctx.stroke();
                ctx.setLineDash([]);
            }
            
            // Lineas de gradiente de concentracion
            ctx.strokeStyle = 'rgba(231, 76, 60, 0.4)';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            for (let r = 30; r < maxRadius; r += 40) {
                ctx.beginPath();
                ctx.arc(feedX, feedY, r, 0, Math.PI * 2);
                ctx.stroke();
            }
            ctx.setLineDash([]);
            
            // Agitador simple para mostrar que hay mezclado (pero no perfecto)
            const agitatorAngle = practicalTime * 1;
            ctx.strokeStyle = '#2c3e50';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(centerX, centerY - 25);
            ctx.lineTo(centerX, centerY + 25);
            ctx.stroke();
            
            // Aspas del agitador
            for (let i = 0; i < 2; i++) {
                const angle = agitatorAngle + (i * Math.PI);
                const endX = centerX + Math.cos(angle) * 20;
                const endY = centerY + Math.sin(angle) * 20;
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(endX, endY);
                ctx.stroke();
            }
            
            // Etiquetas principales
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 16px Arial';
            ctx.fillText('Difusion en Biorreactor', 10, 25);
            
            ctx.font = '12px Arial';
            ctx.fillStyle = '#e74c3c';
            ctx.fillText('Alta concentracion (punto alimentacion)', 10, 45);
            ctx.fillStyle = '#3498db';
            ctx.fillText('Baja concentracion (periferia)', 10, 65);
            ctx.fillStyle = '#27ae60';
            ctx.fillText('Celulas consumiendo sustrato', 10, 85);
            
            // Ley de Fick
            ctx.fillStyle = '#9b59b6';
            ctx.font = 'bold 11px Arial';
            ctx.fillText('J = -D √ó (dC/dx)', canvas.width - 120, 25);
            ctx.font = '10px Arial';
            ctx.fillText('Flujo proporcional', canvas.width - 120, 40);
            ctx.fillText('al gradiente', canvas.width - 120, 52);
        }

        // Inicializar
        setTimeout(function() {
            drawFrame();
            updateStats();
        }, 100);
    </script>
</body>
</html>